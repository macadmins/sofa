name: 01 - SOFA build pipeline

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      pipeline_stage:
        description: 'Pipeline stage to run'
        type: choice
        default: 'all'
        options:
        - all
        - gather
        - fetch
        - build
        - bulletin
        - rss
      commit_results:
        description: 'Commit generated data to repository'
        type: boolean
        default: true
  schedule:
    # Monday, Tuesday, Wednesday, Thursday, and Friday every 1 hour from 5:00 PM to 8:00 PM CET
    - cron: '0 17-20 * * 1,2,3,4,5'

    # On every day every 6 hours
    - cron: '30 */6 * * *'
env:
  PYTHON_VERSION: '3.13'

jobs:
  pipeline:
    name: SOFA Production Pipeline
    runs-on: ubuntu-latest
    if: github.event.repository.fork == false

    steps:
      - name: Setup processing directory
        run: |
          echo "ðŸ—ï¸ Setting up processing environment..."
          mkdir -p processing
          
      - name: Checkout repository to processing folder
        uses: actions/checkout@v4
        with:
          path: processing
        
      - name: Show environment info
        run: |
          echo "## ðŸ­ Production Pipeline Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OS:** $(lsb_release -d | cut -f2)" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** $(uname -m)" >> $GITHUB_STEP_SUMMARY
          echo "**Kernel:** $(uname -r)" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** $(python3 --version)" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Stage:** ${{ github.event.inputs.pipeline_stage }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Results:** ${{ github.event.inputs.commit_results }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show architecture details
          echo "ðŸ–¥ï¸ Runner Architecture Details:"
          uname -a
          lscpu | head -5 || echo "lscpu not available"
          
          echo "ðŸ“ Working from processing directory:"
          cd processing
          pwd
          ls -la
          
      - name: Install Apple Root Certificates
        run: |
          echo "ðŸ” Installing Apple root certificates for SSL validation..."
          
          # Update package database
          sudo apt-get update
          
          # Install ca-certificates if not present
          sudo apt-get install -y ca-certificates curl
          
          # Download and install Apple Root CA-G3 (current primary root)
          echo "ðŸ“¥ Downloading Apple Root CA-G3..."
          sudo curl -f -o /usr/local/share/ca-certificates/apple-root-ca-g3.crt \
            "https://www.apple.com/certificateauthority/AppleRootCA-G3.cer"
          
          # Download and install Apple Root CA (legacy support)
          echo "ðŸ“¥ Downloading Apple Root CA (legacy)..."
          sudo curl -f -o /usr/local/share/ca-certificates/apple-root-ca.crt \
            "https://www.apple.com/certificateauthority/AppleComputerRootCertificate.cer"
          
          # Update system certificate store
          echo "ðŸ”„ Updating system certificate store..."
          sudo update-ca-certificates
          
          # Verify installation
          echo "âœ… Apple certificates installed:"
          ls -la /usr/local/share/ca-certificates/apple-*
          
          # Test SSL connection to Apple Developer
          echo "ðŸ§ª Testing SSL connection to developer.apple.com..."
          if curl -I --max-time 10 "https://developer.apple.com/news/releases/" >/dev/null 2>&1; then
            echo "âœ… SSL connection to Apple Developer successful"
          else
            echo "âš ï¸ SSL connection test failed - but continuing anyway"
          fi
          
      - name: Download SOFA CLI binaries
        run: |
          echo "ðŸ“¥ Downloading latest SOFA CLI binaries..."
          cd processing
          mkdir -p bin

          # Use specific version since latest release is marked as prerelease
          DOWNLOAD_URL="https://github.com/headmin/sofa-core-cli/releases/download/v0.1.4"
          LINUX_ZIP="sofa-core-cli-x86_64-linux-binaries.zip"

          echo "  â€¢ Downloading Linux binaries: $LINUX_ZIP"
          if curl -L -f -o "$LINUX_ZIP" "$DOWNLOAD_URL/$LINUX_ZIP"; then
            echo "    âœ… Downloaded: $LINUX_ZIP"

            echo "  â€¢ Extracting binaries..."
            unzip -o -j "$LINUX_ZIP" -d bin/
            chmod +x bin/*
            rm "$LINUX_ZIP"

            echo "    âœ… Extracted and made executable"
            echo "  â€¢ Extracted files:"
            ls -la bin/
          else
            echo "    âŒ Failed to download: $LINUX_ZIP"
            exit 1
          fi


          
      - name: Verify binary execution
        run: |
          echo "ðŸ”§ Verifying essential SOFA CLI binaries..."
          cd processing/bin
          
          # Verify the binaries we need for the pipeline
          ESSENTIAL_BINARIES=("sofa-build" "sofa-cve" "sofa-fetch" "sofa-gather")
          
          for binary in "${ESSENTIAL_BINARIES[@]}"; do
            echo "Verifying $binary..."
            
            # Check if binary exists and is executable
            if [ ! -f "$binary" ]; then
              echo "  âŒ $binary not found"
              continue
            fi
            
            if [ ! -x "$binary" ]; then
              echo "  âŒ $binary not executable"
              continue  
            fi
            
            # Check binary architecture
            echo "  ðŸ” Binary info: $(file "$binary")"
            
            # Test execution and show version
            if VERSION_OUTPUT=$(./"$binary" --version 2>&1); then
              echo "  âœ… $binary: $VERSION_OUTPUT"
            else
              EXITCODE=$?
              echo "  âŒ $binary failed (exit code: $EXITCODE)"
              echo "  ðŸ” Checking binary dependencies..."
              ldd "$binary" 2>/dev/null | head -3 || echo "  Static binary (no dependencies)"
              echo "## âŒ Binary Test Failed" >> $GITHUB_STEP_SUMMARY
              echo "Essential binary \`$binary\` failed with exit code $EXITCODE" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done
          
          # Remove any non-essential binaries that were extracted
          echo "ðŸ§¹ Cleaning up non-essential binaries..."
          rm -f sofa-init 2>/dev/null || true
          ls -la
          
      - name: Set up Python and UV
        run: |
          echo "ðŸ Setting up Python environment..."
          python3 --version
          
          echo "ðŸ“¦ Installing UV..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          
          # UV installs to ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify UV installation
          echo "ðŸ” Checking UV installation..."
          echo "UV install directory contents:"
          ls -la $HOME/.local/bin/ | grep uv || echo "UV not found in .local/bin"
          
          # Test UV directly with full path
          echo "Testing UV with full path:"
          $HOME/.local/bin/uv --version
          
          # Test UV via PATH
          echo "Testing UV via PATH:"
          which uv
          uv --version


          
      - name: Gather stage
        if: github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'gather') || github.event.inputs.pipeline_stage == 'all'
        run: |
          echo "ðŸ“Š GATHER stage..."
          cd processing
          
          echo "ðŸ“ Working from processing directory: $(pwd)"
          echo "ðŸ·ï¸ Git repository state at pipeline start:"
          echo "  Current commit: $(git rev-parse HEAD)"
          echo "  Short commit: $(git rev-parse --short HEAD)"
          echo "  Branch: $(git branch --show-current || echo 'detached')"
          echo "  Commit date: $(git log -1 --format='%ci')"
          echo "  Working directory clean: $([ -z "$(git status --porcelain)" ] && echo 'true' || echo 'false')"
          echo ""
          
          echo "ðŸ“Š Directory structure:"
          ls -la
          
          # Setup environment for processing folder
          export SOFA_BIN_PATH="./bin"
          export PATH="./bin:$HOME/.local/bin:$PATH"
          
          # Directory paths are now relative to processing folder (no absolute paths needed!)
          mkdir -p data/resources data/cache logs
          
          echo "ðŸ“Š Before gather - existing data:"
          ls -la data/resources/ || echo "No resources directory"
          
          # Use the clean, simple pipeline script  
          echo "Running: uv run --script scripts/sofa_pipeline.py run gather"
          if uv run --script scripts/sofa_pipeline.py run gather; then
            echo "âœ… Pipeline GATHER stage completed"
            echo "## âœ… Gather Stage Success" >> $GITHUB_STEP_SUMMARY
            
            # Show captured git info in sofa-status.json
            if [ -f "data/resources/sofa-status.json" ]; then
              echo ""
              echo "ðŸ·ï¸ Git commit captured in sofa-status.json:"
              if command -v jq >/dev/null 2>&1; then
                echo "  $(jq -r '.data_repo // "No data_repo field"' data/resources/sofa-status.json)"
              else
                echo "  $(grep -A 6 '"data_repo"' data/resources/sofa-status.json || echo 'No data_repo field found')"
              fi
            fi
            
            echo ""
            echo "âœ… Clean pipeline completed with built-in verification"
            echo "## âœ… Clean Pipeline Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ GATHER stage failed"
            echo "## âŒ Gather Stage Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: Fetch stage
        if: github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'fetch') || github.event.inputs.pipeline_stage == 'all'
        run: |
          echo "ðŸ” FETCH stage..."
          cd processing

          export SOFA_BIN_PATH="./bin"
          export PATH="./bin:$HOME/.local/bin:$PATH"

          echo "Running: uv run --script scripts/sofa_pipeline.py run fetch"
          if uv run --script scripts/sofa_pipeline.py run fetch; then
            echo "âœ… FETCH stage completed"
            echo "## âœ… Fetch Stage Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ FETCH stage failed"
            echo "## âŒ Fetch Stage Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          




      - name: Build stage
        if: github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'build') || github.event.inputs.pipeline_stage == 'all'
        run: |
          echo "ðŸ”¨ BUILD stage..."
          cd processing

          # Ensure supported_devices.json is in both required locations
          if [ -f "data/models/supported_devices.json" ]; then
            cp data/models/supported_devices.json data/resources/
          fi
          mkdir -p data/models
          if [ -f "data/resources/supported_devices.json" ]; then
            cp data/resources/supported_devices.json data/models/
          fi
          
          echo "âœ… build.toml configured with correct relative paths"

          export SOFA_BIN_PATH="./bin"
          export PATH="./bin:$HOME/.local/bin:$PATH"

          echo "Running: uv run --script scripts/sofa_pipeline.py run build"
          if uv run --script scripts/sofa_pipeline.py run build; then
            echo "âœ… BUILD stage completed"
            echo "## âœ… Build Stage Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ BUILD stage failed"
            echo "## âŒ Build Stage Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Bulletin stage
        if: success() && (github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'bulletin') || github.event.inputs.pipeline_stage == 'all')
        run: |
          echo "ðŸ“‹ BULLETIN stage..."
          cd processing

          export SOFA_BIN_PATH="./bin"
          export PATH="./bin:$HOME/.local/bin:$PATH"

          echo "Running: uv run --script scripts/sofa_pipeline.py run bulletin"
          if uv run --script scripts/sofa_pipeline.py run bulletin; then
            echo "âœ… BULLETIN stage completed"
            echo "## âœ… Bulletin Stage Success" >> $GITHUB_STEP_SUMMARY

            # Show bulletin summary if available
            if [ -f "data/resources/bulletin_data.json" ]; then
              echo "ðŸ“‹ Bulletin data generated successfully"
              echo "- **Bulletin Data**: âœ… Generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ BULLETIN stage failed"
            echo "## âŒ Bulletin Stage Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Show generated files
        if: success() && (github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'build') || github.event.inputs.pipeline_stage == 'all')
        run: |
          echo "ðŸ“ Checking generated files..."
          cd processing
          echo "## ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "data/feeds" ]; then
            echo "### Feeds Directory:" >> $GITHUB_STEP_SUMMARY
            find data/feeds -type f | head -20 | while read file; do
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
              echo "- \`$file\` (${size} bytes)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âŒ No data/feeds directory found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "data/resources" ]; then
            echo "### Resources Directory:" >> $GITHUB_STEP_SUMMARY
            find data/resources -type f | head -20 | while read file; do
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
              echo "- \`$file\` (${size} bytes)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âŒ No data/resources directory found" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: RSS generation with beta validation  
        if: success() && (github.event_name == 'schedule' || contains(github.event.inputs.pipeline_stage, 'rss') || github.event.inputs.pipeline_stage == 'all')
        env:
          SOFA_FQDN: ${{ secrets.SOFA_BASE_URL || 'https://sofa.macadmins.io' }}
          SOFA_BASE_URL: ${{ secrets.SOFA_BASE_URL || 'https://sofa.macadmins.io' }}
        run: |
          echo "ðŸ“¡ RSS generation with beta validation..."
          echo "ðŸŒ Using SOFA_FQDN: $SOFA_FQDN"
          cd processing
          
          # Check for required input files
          echo "ðŸ“Š RSS input files:"
          ls -la data/resources/bulletin_data.json || echo "âŒ bulletin_data.json missing"
          ls -la data/resources/apple_beta_feed.json || echo "âŒ apple_beta_feed.json missing" 
          
          if [ -f "data/resources/bulletin_data.json" ]; then
            echo "âœ… Found bulletin_data.json, generating RSS with beta inclusion..."
            
            # Generate RSS with beta releases included for validation
            if uv run --script scripts/generate_rss.py \
              --output v1/rss_feed.xml \
              --data-dir data/resources \
              --include-xprotect \
              --include-beta \
              --verbose; then
              
              echo "âœ… RSS generation completed"
              echo "## âœ… RSS Generation Success" >> $GITHUB_STEP_SUMMARY
              
              if [ -f "data/feeds/v1/rss_feed.xml" ]; then
                rss_size=$(stat -f%z "data/feeds/v1/rss_feed.xml" 2>/dev/null || stat -c%s "data/feeds/v1/rss_feed.xml" 2>/dev/null)
                echo "Generated RSS feed: ${rss_size} bytes" >> $GITHUB_STEP_SUMMARY
                
                # RSS generation output already shows beta count
                echo "âœ… RSS generation includes comprehensive beta validation"
                echo "- **RSS Generation**: âœ… Includes beta releases" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ RSS generation failed"
              echo "## âŒ RSS Generation Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No bulletin_data.json found, skipping RSS test"
            echo "## âš ï¸ RSS Test Skipped" >> $GITHUB_STEP_SUMMARY
            echo "No bulletin_data.json found for RSS generation" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Commit pipeline results
        if: github.event.inputs.commit_results == 'true' || github.event_name == 'schedule'
        run: |
          echo "ðŸ’¾ Committing generated data back to repository..."
          cd processing
          
          # Show what data was generated
          echo "ðŸ” Generated data structure:"
          find data/ -type f | head -20 || echo "No data files found"
          
          # Add generated data
          git config --local user.email "action@github.com"
          git config --local user.name "SOFA Pipeline"
          
          # Add all feeds and resources
          echo "ðŸ“ Adding feeds and resources:"
          git add v1/macos_data_feed.json && echo "âœ… Added v1/macos_data_feed.json" || echo "âŒ v1/macos_data_feed.json not found or unchanged"
          git add v1/ios_data_feed.json && echo "âœ… Added v1/ios_data_feed.json" || echo "âŒ v1/ios_data_feed.json not found or unchanged"
          git add v1/rss_feed.xml && echo "âœ… Added v1/rss_feed.xml" || echo "âŒ v1/rss_feed.xml not found or unchanged"
          git add v2/ && echo "âœ… Added v2 feeds" || echo "âŒ v2 directory not found or unchanged"
          git add data/resources/ && echo "âœ… Added all resources" || echo "âŒ resources directory not found or unchanged"
          
          if git diff --staged --quiet; then
            echo "ðŸ“ No new data to commit"
          else
            echo "ðŸ“ Analyzing changes for detailed commit message..."
            
            # Analyze what actually changed
            CHANGED_FILES=$(git diff --staged --name-only)
            echo "ðŸ“Š Files being committed:"
            echo "$CHANGED_FILES"
            
            # Count changes reliably
            V1_COUNT=$(echo "$CHANGED_FILES" | grep -c "^v1/" 2>/dev/null || echo "0")
            V2_COUNT=$(echo "$CHANGED_FILES" | grep -c "^v2/" 2>/dev/null || echo "0")
            RESOURCES_COUNT=$(echo "$CHANGED_FILES" | grep -c "data/resources/" 2>/dev/null || echo "0")
            TOTAL_CHANGES=$(echo "$CHANGED_FILES" | wc -l)
            
            # Simple, clean change analysis - no complex logic that can fail
            
            # Create clean, reliable commit message
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            echo "ðŸ“ Committing pipeline data with clean summary..."
            
            # Build simple summary
            CHANGE_SUMMARY=""
            if [ "$V1_COUNT" -gt 0 ]; then
              CHANGE_SUMMARY="${CHANGE_SUMMARY}v1 ($V1_COUNT), "
            fi
            if [ "$V2_COUNT" -gt 0 ]; then
              CHANGE_SUMMARY="${CHANGE_SUMMARY}v2 ($V2_COUNT), "
            fi
            if [ "$RESOURCES_COUNT" -gt 0 ]; then
              CHANGE_SUMMARY="${CHANGE_SUMMARY}resources ($RESOURCES_COUNT), "
            fi
            CHANGE_SUMMARY=$(echo "$CHANGE_SUMMARY" | sed 's/, $//')
            
            git commit -m "ðŸ”„ SOFA pipeline update - $TIMESTAMP

            Pipeline stage: ${{ github.event.inputs.pipeline_stage }} | Files: $TOTAL_CHANGES
            Updates: $CHANGE_SUMMARY
            
            Generated with sofa_pipeline.py v0.2.0 + v0.1.1-beta1 binaries"
            
            git push
            echo "âœ… Detailed pipeline data committed to repository"
            
            echo ""
            echo "ðŸ·ï¸ Git repository state after pipeline commit:"
            echo "  New commit: $(git rev-parse HEAD)"
            echo "  Short commit: $(git rev-parse --short HEAD)"
            echo "  Branch: $(git branch --show-current || echo 'detached')"
            echo "  Commit date: $(git log -1 --format='%ci')"
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-debug-${{ github.run_number }}
          path: |
            processing/logs/
            processing/data/resources/
            processing/v1/
            processing/v2/
          retention-days: 7
          if-no-files-found: warn
          
      - name: Pipeline summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Pipeline Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Stage:** ${{ github.event.inputs.pipeline_stage }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Clean pipeline provides comprehensive output with built-in verification." >> $GITHUB_STEP_SUMMARY

